# Story 4.2: AI-Powered Content Refinement

**Epic:** AI Letter Generation
**Status:** Ready for Development
**Priority:** P1 (Post-MVP)
**Story Points:** 13
**Dependencies:** Story 4.1 (AI Letter Generation)

---

## Title
Implement AI-powered content refinement and tone adjustment

---

## Description
Build refinement service allowing attorneys to improve specific letter sections using natural language instructions, adjusting tone, adding detail, or rephrasing content with AI assistance.

---

## Acceptance Criteria

### Refinement Endpoint
- [ ] POST /api/letters/{letterId}/refine endpoint
- [ ] Authentication required
- [ ] Accepts:
  - [ ] selectedText (or sectionId for full section)
  - [ ] instruction (natural language directive)
  - [ ] applyScope: "selection" | "section" | "entire_document"
- [ ] Returns:
  - [ ] Original text
  - [ ] Refined text
  - [ ] Confidence score (0-100)
  - [ ] Token usage

### Refinement UI
- [ ] Right sidebar "AI Refine" tab
- [ ] Text area: "Enter refinement instructions..."
- [ ] Example suggestions:
  - [ ] "Make this more detailed"
  - [ ] "Adjust tone to be more aggressive"
  - [ ] "Expand on damages calculation"
  - [ ] "Fix grammatical errors"
  - [ ] "Make more concise"
- [ ] Scope selection: Selected text | Entire document
- [ ] "Refine" button triggers refinement
- [ ] Processing indicator with estimated time
- [ ] Cancel option for long operations

### Refinement Review
- [ ] Side-by-side comparison:
  - [ ] Left: Original text
  - [ ] Right: Refined text
- [ ] Differences highlighted:
  - [ ] Additions in green
  - [ ] Deletions in red
  - [ ] Changed text in orange
- [ ] Accept/Reject buttons
- [ ] Accept replaces original with refined text
- [ ] Reject discards suggestions
- [ ] Undo refinement via standard undo

### Tone Adjustment
- [ ] Preset tone options:
  - [ ] Professional (neutral)
  - [ ] Aggressive (assertive, demanding)
  - [ ] Conciliatory (reasonable, open to negotiation)
  - [ ] Formal (legal, technical)
- [ ] User selects tone
- [ ] System adjusts language while preserving facts
- [ ] Applied to selected text or entire document
- [ ] Preview before accepting

### Performance
- [ ] Refinement completes in < 30 seconds typical
- [ ] Non-blocking (user can continue editing)
- [ ] Streams response for real-time display
- [ ] Handles large selections gracefully
- [ ] Timeout with user-friendly error

### Error Handling
- [ ] No text selected → clear error message
- [ ] API failure → retry option
- [ ] Timeout → user-friendly error
- [ ] Invalid scope → validation error
- [ ] All errors logged for debugging

### Monitoring
- [ ] CloudWatch metrics:
  - [ ] Refinement count
  - [ ] Average processing time
  - [ ] Success rate
  - [ ] User adoption
- [ ] Refinement logs tracked per letter

### Testing
- [ ] Unit tests for prompt construction
- [ ] Integration tests with Claude API
- [ ] Test various text lengths
- [ ] Test all tone presets
- [ ] Test coverage > 80%

---

## Technical Notes

### Refinement Prompt Engineering

```python
def build_refinement_prompt(original_text, instruction, tone):
    return f"""
    You are an expert legal writing assistant.

    Original text:
    {original_text}

    Task: {instruction}
    Tone: {tone}

    Provide only the refined text without explanation.
    Preserve all factual content.
    Maintain professional legal language.
    Keep approximately the same length.

    Refined text:
    """
```

### Tone Adjustments

```python
TONE_PROMPTS = {
    "professional": "Use neutral, objective language appropriate for formal legal correspondence.",
    "aggressive": "Use assertive language that clearly emphasizes the strength of the client's position. Be demanding but professional.",
    "conciliatory": "Use reasonable language that appears open to negotiation while protecting the client's interests.",
    "formal": "Use formal, technical legal language. Include appropriate legal references and citations where relevant."
}
```

### Backend Implementation

```typescript
router.post('/letters/:letterId/refine', authenticate, async (req, res) => {
  const { selectedText, instruction, scope } = req.body;

  // Validate
  if (!selectedText || !instruction) {
    return res.status(400).json({ error: 'Missing required fields' });
  }

  // Invoke Python Lambda
  const lambdaResponse = await lambda.invoke({
    FunctionName: 'ai-refinement-processor',
    InvocationType: 'RequestResponse',
    Payload: JSON.stringify({
      text: selectedText,
      instruction,
      scope,
    }),
  }).promise();

  const { refinedText, tokens, confidence } = JSON.parse(lambdaResponse.Payload);

  // Log refinement
  await RefinementLog.create({
    letter_id: letterId,
    instruction,
    original_length: selectedText.length,
    refined_length: refinedText.length,
    tokens_used: tokens.total,
    user_id: req.user.id,
  });

  return res.json({
    originalText: selectedText,
    refinedText,
    confidence,
    tokensUsed: tokens,
  });
});
```

---

## Success Metrics
- [ ] Refinement quality meets attorney expectations
- [ ] Processing completes in < 30 seconds
- [ ] User adoption > 60% of active users
- [ ] Satisfaction rating > 4/5

---

## Related Stories
- **4.1**: AI Letter Generation (builds on this)
- **6.1**: Letter Editor (UI for refinement)

---

## Sign-Off
- [ ] AI/ML Lead reviews prompt engineering
- [ ] Product Owner confirms user workflow
- [ ] UX Designer approves interface

